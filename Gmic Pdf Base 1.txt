import { PDFDocument, StandardFonts, rgb } from "pdf-lib";
import MarkdownIt from "markdown-it";

export default async function handler(req, res) {
  try {
    const { filename = "output.pdf", content = "" } = req.body;

    const md = new MarkdownIt();
    const html = md.render(content);
    const text = html.replace(/<[^>]+>/g, "");

    const pdfDoc = await PDFDocument.create();
    const page = pdfDoc.addPage([612, 792]); // Letter size
    const { width, height } = page.getSize();

    const font = await pdfDoc.embedFont(StandardFonts.Helvetica);
    const fontBold = await pdfDoc.embedFont(StandardFonts.HelveticaBold);

    let y = height - 50;

    // Header
    page.drawText("THE REPORT: Solicitation Summary", {
      x: 50,
      y: y,
      size: 14,
      font: fontBold
    });

    y -= 40;

    // Body text
    const lines = text.split("\n");
    for (let line of lines) {
      if (y < 50) {
        page = pdfDoc.addPage([612, 792]);
        y = height - 50;
      }

      page.drawText(line, {
        x: 50,
        y: y,
        size: 10,
        font: font
      });

      y -= 14;
    }

    // Footer
    page.drawText("Generated by SRE â€“ Solicitation Report Engine", {
      x: 50,
      y: 30,
      size: 8,
      font: font
    });

    const pdfBytes = await pdfDoc.save();

    res.setHeader("Content-Type", "application/pdf");
    res.setHeader("Content-Disposition", `attachment; filename=${filename}`);
    res.send(Buffer.from(pdfBytes));

  } catch (err) {
    res.status(500).json({ error: err.message });
  }
}
